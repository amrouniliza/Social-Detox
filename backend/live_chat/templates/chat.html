<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        #chatSection {
           display: none;
        }

        #chatMessages {
            height: 300px;
            border: 1px solid #ccc;
            overflow-y: scroll;
            padding: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">

               
                <div id="joinSection" class="card">
                    <div class="card-body">
                        <h4 class="card-title">Rejoindre le Chat</h4>
                        <div class="mb-3">
                            <label for="usernameInput" class="form-label">Nom d'utilisateur</label>
                            <input type="text" id="usernameInput" class="form-control" placeholder="Entrez votre nom d'utilisateur">
                        </div>
                        <button id="joinButton" class="btn btn-primary w-100">Rejoindre</button>
                    </div>
                </div>

                <!-- Chat Section -->
                <div id="chatSection" class="card mt-3">
                    <div class="card-body">
                        <h4 class="card-title">Zone de Chat</h4>
                        <div id="chatMessages"></div>
                        <div class="input-group">
                            <input type="text" id="messageInput" class="form-control" placeholder="Tapez votre message...">
                            <button class="btn btn-primary" id="sendMessageButton">Envoyer</button>
                            <button class="btn btn-danger" id="leaveChatButton">Quitter le Chat</button> 
                            
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <script src="/socket.io/socket.io.js"> </script>
    <script>
        const socket = io();

        document.addEventListener('DOMContentLoaded', function () {
    var username = 'https://my-express-app-1058119729143.us-central1.run.app';
   // const socket = io('https://my-express-app-1058119729143.us-central1.run.app'); 

   
    document.getElementById('joinButton').addEventListener('click', function () {
        username = document.getElementById('usernameInput').value.trim();
        console.log("Username entered:", username);
        
        if (username) {
            socket.emit('joinChat', username); 
            document.getElementById('joinSection').style.display = 'none'; 
            document.getElementById('chatSection').style.display = 'block'; 

            socket.on('welcome', (userName) => {
                const newMessage = document.createElement('p');
                newMessage.className = 'fw-light';
                newMessage.textContent = `${userName} a rejoint le chat`;
                document.getElementById('chatMessages').appendChild(newMessage);
            });
        }
    });

    document.getElementById('sendMessageButton').addEventListener('click', sendMessage);
    
    document.getElementById('messageInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    async function sendMessage() {
    const message = document.getElementById('messageInput').value.trim();

    if (message) {
        try {
            
//onst response = await fetch('http://127.0.0.1:5000/detect_insult'
            console.log('Hello i ')
            
            const response = await fetch('https://social-detox-cr-1058119729143.us-central1.run.app/is-toxic', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ text: message ,  api_key:"AIzaSyA6fXrzT-8uyYjpETkvYd-zZUHZqDgdcgU"}) 
            });
            console.log('Hello éé',response)

            
            const data = await response.json(); 

            console.log('DATA',data)
           
            // const label = data[0].label;
            // const score = data[0].score;
            // console.log(score);
            const score = data.isTocic;

     
            if (!score) {
               
                document.getElementById('messageInput').value = ''; 
                socket.emit('sendMsg', message, username); 

                const newMessage = document.createElement('p');
                newMessage.className = 'fw-light';
                newMessage.textContent = `${username}: ${message}`;
                document.getElementById('chatMessages').appendChild(newMessage);
            } else {
                alert("Message bloqué : Contenu toxique détecté."); 
            }
        } catch (error) {
            console.error('Erreur lors de la vérification du message :', error);
        }
    }
}














    socket.on('receivedMsg', (msg, username) => {
        const newMessage = document.createElement('p');
        newMessage.innerHTML = `<strong>${username}:</strong> ${msg}`;
        document.getElementById('chatMessages').appendChild(newMessage);
        document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight; 
    });

    socket.on('userDisconected', (userName) => {
        const newMessage = document.createElement('p');
        newMessage.innerHTML = `${userName} a quité le chat`;
        newMessage.className="fw-lighter"
        document.getElementById('chatMessages').appendChild(newMessage);
        document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
    });

    document.getElementById('leaveChatButton').addEventListener('click', function () {
            socket.emit('leaveChat', username); 
            document.getElementById('chatSection').style.display = 'none'; 
            document.getElementById('joinSection').style.display = 'block'; 
        });

    
});


      </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.min.js"></script>
</body>
</html>
  

  
